import os
import sys
import subprocess
from telethon import events
from __main__ import client, load_plugins # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ

# --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
SECTION_NAME = "ğŸ”„ Ù†Ù€Ø¸Ù€Ø§Ù… Ø§Ù„Ù€ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø« Ø§Ù„Ù€Ù…Ù€Ø·Ù€ÙˆØ±"
COMMANDS = (
    "â€¢ `.ØªØ­Ø¯ÙŠØ«` : Ø¬Ù€Ù„Ù€Ø¨ Ø§Ù„Ø£ÙˆØ§Ù…Ù€Ø± Ø§Ù„Ù€Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø© Ù…Ù€Ù† GitHub\n"
    "â€¢ `.ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«` : Ø§Ù„Ù€ØªÙ€Ø£ÙƒÙ€Ø¯ Ù…Ù€Ù† ÙˆØ¬Ù€ÙˆØ¯ ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø«Ù€Ø§Øª Ù…Ù€ØªÙ€ÙˆÙÙ€Ø±Ø©"
)

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ÙØ­Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«'))
async def check_update(event):
    await event.edit("ğŸ“¡ **Ø¬Ù€Ø§Ø±Ù ÙÙ€Ø­Ù€Øµ Ø§Ù„Ù€Ù…Ù€Ø³Ù€ØªÙ€ÙˆØ¯Ø¹ Ø¹Ù€Ù† ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø«Ù€Ø§Øª Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø©...**")
    try:
        # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ø¯ÙˆÙ† Ø¯Ù…Ø¬Ù‡Ø§
        subprocess.check_output(["git", "fetch"])
        status = subprocess.check_output(["git", "status", "-uno"]).decode("utf-8")
        
        if "Your branch is up to date" in status:
            await event.edit("âœ… **Ø§Ù„Ù€Ø³Ù€ÙˆØ±Ø³ Ù…Ù€Ø­Ù€Ø¯Ø« Ø¨Ù€Ø§Ù„Ù€ÙƒÙ€Ø§Ù…Ù€Ù„ Ù„Ø¢Ø®Ù€Ø± Ø¥ØµÙ€Ø¯Ø§Ø±.**")
        else:
            await event.edit("ğŸ†• **Ù‡Ù€Ù†Ù€Ø§Ùƒ ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø«Ù€Ø§Øª Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø© Ù…Ù€ØªÙ€ÙˆÙÙ€Ø±Ø©!**\nØ§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø± `.ØªØ­Ø¯ÙŠØ«` Ù„Ù€ØªÙ€Ø«Ù€Ø¨Ù€ÙŠÙ€ØªÙ€Ù‡Ù€Ø§ Ø§Ù„Ø¢Ù†.")
    except Exception as e:
        await event.edit(f"âŒ **ÙÙ€Ø´Ù„ Ø§Ù„Ù€ÙÙ€Ø­Øµ:**\n`{str(e)[:100]}`")

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ØªØ­Ø¯ÙŠØ«'))
async def update_source(event):
    await event.edit("ğŸ”„ **Ø¬Ù€Ø§Ø±Ù Ø¬Ù€Ù„Ù€Ø¨ Ø§Ù„Ø£ÙˆØ§Ù…Ù€Ø± Ø§Ù„Ù€Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø© ÙˆØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø« Ø§Ù„Ù€Ø³Ù€ÙˆØ±Ø³...**")
    
    try:
        # ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† GitHub
        pull_output = subprocess.check_output(["git", "pull"]).decode("utf-8")
        
        if "Already up to date" in pull_output:
            return await event.edit("âœ… **Ù„Ø§ ØªÙ€ÙˆØ¬Ù€Ø¯ Ø£ÙˆØ§Ù…Ù€Ø± Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø© Ù…Ù€Ø¶Ù€Ø§ÙÙ€Ø©.**")

        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¬Ù„Ø¨
        await event.edit("âš™ï¸ **ØªÙ€Ù… Ø¬Ù€Ù„Ù€Ø¨ Ø§Ù„Ù€Ù…Ù€Ù„Ù€ÙØ§Øª! Ø¬Ù€Ø§Ø±Ù ØªÙ€ÙÙ€Ø¹Ù€ÙŠÙ€Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ù€Ø± Ø§Ù„Ù€Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø©...**")
        
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ù…Ù† main.py
        load_plugins()
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø³ Ù„Ø¶Ù…Ø§Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø°Ø±ÙŠØ©
        await event.edit("âœ… **ØªÙ€Ù… Ø§Ù„Ù€ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø« Ø¨Ù€Ù†Ù€Ø¬Ù€Ø§Ø­! Ø¬Ù€Ø§Ø±Ù Ø¥Ø¹Ù€Ø§Ø¯Ø© ØªÙ€Ø´Ù€ØºÙ€ÙŠÙ€Ù„ Ø§Ù„Ù€Ù…Ù€Ø­Ù€Ø±Ùƒ...**")
        os.execl(sys.executable, sys.executable, *sys.argv)
        
    except Exception as e:
        await event.edit(f"âŒ **Ø­Ù€Ø¯Ø« Ø®Ù€Ø·Ø£ Ø£Ø«Ù€Ù†Ù€Ø§Ø¡ Ø§Ù„Ù€ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø«:**\n`{str(e)[:100]}`")
