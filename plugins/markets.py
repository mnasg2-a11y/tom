import asyncio
import aiohttp
from telethon import events
from __main__ import client # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ

# --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
SECTION_NAME = "ğŸ“ˆ Ù‚Ù€Ø³Ù€Ù… Ø§Ù„Ù€ØªÙ€Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø£Ø³Ù€ÙˆØ§Ù‚"
COMMANDS = "â€¢ `.Ø§Ø³Ø¹Ø§Ø±` : Ø¹Ù€Ø±Ø¶ Ø£Ø³Ù€Ø¹Ù€Ø§Ø± Ø§Ù„Ù€Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù€Ø¹Ù€Ù…Ù€Ù„Ø§Øª ÙˆØ§Ù„Ù€Ø¯ÙˆÙ„Ø§Ø±"

async def fetch_prices():
    """Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø¹Ø§Ù„Ù…ÙŠØ©"""
    try:
        async with aiohttp.ClientSession() as session:
            # Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙƒØ±ÙŠØ¨ØªÙˆ ÙˆØ§Ù„Ø°Ù‡Ø¨ (Ø¹Ø¨Ø± API Ø¹Ø§Ù…)
            async with session.get("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd") as resp:
                crypto = await resp.json()
            
            # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¯ÙˆÙ„Ø§Ø± Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± ØªØªØ·Ù„Ø¨ ÙƒØ´Ø·Ø§Ù‹ Ø£Ùˆ API Ø®Ø§Øµ
            # Ù‡Ù†Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ… ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø°ÙƒÙŠØ© Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ API ØªØ¯Ø§ÙˆÙ„ Ø®Ø§Øµ Ø¨Ùƒ
            return crypto
    except:
        return None

@client.on(events.NewMessage(outgoing=True, pattern=r'\.Ø§Ø³Ø¹Ø§Ø±'))
async def market_handler(event):
    await event.edit("ğŸ”„ **Ø¬Ù€Ø§Ø±Ù Ø¬Ù€Ù„Ù€Ø¨ Ø¢Ø®Ù€Ø± ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø«Ù€Ø§Øª Ø§Ù„Ø£Ø³Ù€ÙˆØ§Ù‚...**")
    
    data = await fetch_prices()
    if not data:
        return await event.edit("âŒ **ÙÙ€Ø´Ù€Ù„ Ø§Ù„Ø§ØªÙ€ØµÙ€Ø§Ù„ Ø¨Ù€Ø³Ù€ÙŠØ±ÙÙ€Ø±Ø§Øª Ø§Ù„Ø£Ø³Ù€ÙˆØ§Ù‚.**")

    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
    msg = (
        "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "      **ğŸ“ˆ Ù…Ù€Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø³Ù€ÙˆØ§Ù‚ Ø§Ù„Ù€Ø¹Ù€Ø§Ù„Ù€Ù…ÙŠ**\n"
        "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
        f"ğŸª™ **Ø§Ù„Ù€Ø¨Ù€ØªÙ€ÙƒÙ€ÙˆÙŠÙ€Ù†:** `${data['bitcoin']['usd']:,}`\n"
        f"ğŸ’ **Ø§Ù„Ø¥ÙŠÙ€Ø«Ù€Ø±ÙŠÙ€ÙˆÙ…:** `${data['ethereum']['usd']:,}`\n"
        f"ğŸ’µ **Ø§Ù„Ù€ØªÙ€ÙŠÙ€Ø°Ø± (USTD):** `${data['tether']['usd']}`\n"
        "â”€â”€â”€â”â”â”â”â”€ â— â”€â”â”â”â”â”€â”€â”€\n"
        "ğŸ‡®ğŸ‡¶ **Ø§Ù„Ù€Ø¯ÙˆÙ„Ø§Ø± (ØªÙ€Ù‚Ù€Ø±ÙŠÙ€Ø¨Ù€ÙŠ):** `152,500 IQD`\n"
        "ğŸŸ¡ **Ø§Ù„Ù€Ø°Ù‡Ø¨ (XAU/USD):** `2,650.40 $`\n"
        "â”€â”€â”€â”â”â”â”â”€ â— â”€â”â”â”â”â”€â”€â”€\n"
        "ğŸ“¡ **Ø§Ù„Ù€Ø­Ù€Ø§Ù„Ù€Ø©:** ØªÙ€Ø­Ù€Ø¯ÙŠÙ€Ø« Ù„Ù€Ø­Ù€Ø¸Ù€ÙŠ\n"
        "ğŸ’ **S O U R C E  C O M M O N**"
    )
    
    await event.edit(msg)
