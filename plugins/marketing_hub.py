import asyncio
from telethon import events
from __main__ import client # ุงุณุชูุฑุงุฏ ุงูุนููู ุงูุฃุณุงุณู
# ุงุณุชุฏุนุงุก ุงูุฃูุธูุฉ ูู ูููู ุงูุฌุฏูุฏ
from ุงูุชุนุฏูู_ูู_ุฌุฏูุฏ import referral_system, gemini_ai 

# --- ุจูุงูุงุช ุงููุณู ูููุญุฉ ุงูุฃูุงูุฑ ุงูุชููุงุฆูุฉ ---
SECTION_NAME = "๐ข ููุฑููุฒ ุงููููุดุฑ ูุงููุชูุณููู"
COMMANDS = "โข `.ูุดุฑ` : ููุนูุฑุถ ูููุญูุฉ ุงููุชูุญููู ููู ุงููุฅุนููุงูุงุช ูุงููุฅุญูุงูุงุช"

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ูุดุฑ$'))
async def marketing_dashboard(event):
    # ูุงุฌูุฉ ุงููุดุฑ ุงูุงุญุชุฑุงููุฉ (ุชุฌูุน 5 ุฃุฏูุงุช ุชุณููููุฉ)
    dashboard = (
        "โโโโโโโโโโโโโโโโโโโโโโ\n"
        "      **๐ข ููุฑููุฒ ููุดุฑ ูููููู  P R O**\n"
        "โโโโโโโโโโโโโโโโโโโโโโ\n\n"
        "๐ **ุฃุฏูุงุช ุงููุชูุณููู ูุงููุชูุณูุน ุงููุฐููู:**\n\n"
        "1๏ธโฃ `.ูุดุฑ_ุชููุงุฆู` + ูุต + ููุช : ููุจุฏุก ุญููุฉ ููุดุฑ ูุณุชูุฑุฉ\n"
        "2๏ธโฃ `.ุฑุงุจุทู` : ููุชูููุฏ ุฑุงุจูุท ุฅุญูุงูุฉ ููุน ูููุฏ QR ุฌูุงูุฒ\n"
        "3๏ธโฃ `.ูุต_ุชุฑููุฌู` : ููุฌุนู ุงููุฐูุงุก ูููุชุจ ููู ุฅุนููุงูุงู ุฌูุฐุงุจุงู\n"
        "4๏ธโฃ `.ุชุตููุฉ_ุงููุดุฑ` : ููุฅููุงู ุฌูููุน ุญูููุงุช ุงูููุดุฑ ุงูููุดุทุฉ\n"
        "5๏ธโฃ `.ุงุฑุจุงุญู` : ูููุฑุงูุจุฉ ุฃุฑุจูุงุญ ุงููุดุฑูุงุก ูุงููุชุญูููุงุช ุงููููููุฉ\n"
        "โโโโโโโโ โ โโโโโโโโ\n"
        "๐ข **ุงููููุงุฉ:** @iomk3 | ๐ค **ุงูููุทูุฑ:** @iomk0\n"
        "๐ **S O U R C E  C O M M O N**"
    )
    await event.edit(dashboard)

# --- ุชูุนูู ุงูุฃูุงูุฑ ุงูู 5 ุงููุฑุนูุฉ ุจูุงุกู ุนูู ููุทู ูููู ---

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ูุดุฑ_ุชููุงุฆู (.*)'))
async def auto_post_cmd(event):
    # ุงุณุชุฎุฏุงู ููุทู ุงููุดุฑ ุงูุชููุงุฆู ูู ูููู
    try:
        parts = event.pattern_match.group(1).rsplit(' ', 1)
        msg_text, interval = parts[0], int(parts[1])
        if interval < 30: return await event.edit("โ๏ธ **ุงููููุช ุงููุฃุฏูู 30 ุซูุงููุฉ.**")
        
        await event.edit(f"โ **ุชูู ุจูุฏุก ุงูููุดุฑ ุงููุชููุงุฆู ูู `{interval}` ุซุงููุฉ.**")
        # ููุทู ุงูู Loop ูููุดุฑ
        while True:
            await asyncio.sleep(interval)
            await client.send_message(event.chat_id, msg_text)
    except:
        await event.edit("โ๏ธ **ุงููุงุณุชุฎุฏุงู:** `.ูุดุฑ_ุชููุงุฆู [ุงูููุต] [ุงููุซูุงูู]`")

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ุฑุงุจุทู'))
async def my_ref_link(event):
    await event.edit("๐ **ุฌูุงุฑู ุชููููุฏ ุฑุงุจูุท ุงููุฅุญูุงูุฉ ูุงูู QR...**")
    # ุงุณุชุฎุฏุงู ูุธุงู ุงูุฅุญุงูุฉ ุงููุชูุฏู ูู ูููู
    ref_data = referral_system.generate_referral_link(event.sender_id)
    msg = (
        f"๐ **ุฑุงุจูุท ุงููุฅุญูุงูุฉ ุงููุฎุงุต ุจูู:**\n`{ref_data['telegram_link']}`\n\n"
        f"๐ผ **ูููุฏ QR ููููุชูุณููู:**\n{ref_data['qr_code']}\n"
        f"๐ **ุงููููุงูุฃุฉ:** 3 ุฃููุงู ููุฌุงููุฉ ูููู ููุฏุนู"
    )
    await event.edit(msg)

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ูุต_ุชุฑููุฌู'))
async def ai_promo_gen(event):
    await event.edit("๐ง **ุงููุฐูุงุก ุงููุงุตุทูุงุนู ููููู ุจููุชุงุจุฉ ุฅุนููุงู ููู...**")
    # ุงุณุชุฎุฏุงู Gemini AI ูู ูููู ููุชุงุจุฉ ูุญุชูู ุชุณูููู
    promo = await gemini_ai.chat(event.sender_id, "ุงูุชุจ ูุต ุชุฑููุฌู ุฌุฐุงุจ ููุตูุฑ ูุณูุฑุณ ุชููุฌุฑุงู ุงุญุชุฑุงูู ุงุณูู ูููู ุจุฑู")
    await event.edit(f"๐ **ุงููุฅุนููุงู ุงููููุชุฑุญ:**\n\n{promo}")

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ุชุตููุฉ_ุงููุดุฑ'))
async def stop_all_posts(event):
    # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑุณ ุฃู ุฅููุงู ุงูููุงู
    await event.edit("๐ **ุชูู ุฅูููุงู ุฌูููุน ุญูููุงุช ุงูููุดุฑ ุงููุชููุงุฆู.**")
    # ููุง ูููู ุฅุถุงูุฉ ููุทู ูุฅูุบุงุก ุงูููุงู (Task Cancel)

@client.on(events.NewMessage(outgoing=True, pattern=r'\.ุงุฑุจุงุญู'))
async def check_earnings(event):
    stats = referral_system.get_partner_stats(event.sender_id)
    if "error" in stats: return await event.edit("โ๏ธ **ููู ุชููุถู ูููุธุงู ุงููุดุฑูุงุก ุจูุนุฏ.**")
    
    msg = (
        "๐ฐ **ุฅุญูุตุงุฆูุงุช ุฃุฑุจูุงุญู:**\n"
        f"โข ุงููุฃุฑุจูุงุญ ุงูููููุฉ: `${stats['total_earnings']}`\n"
        f"โข ุงููุฑุตูุฏ ุงูููุนูู: `${stats['pending_earnings']}`\n"
        f"โข ุนูุฏุฏ ุงููุฅุญุงูุงุช: `{stats['successful_invites']}` ุฅุญูุงูุฉ ููุงุฌุญุฉ"
    )
    await event.edit(msg)
